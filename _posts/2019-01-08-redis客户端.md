--- 
layout: post 
title: redis客户端 
date: 2019-01-08 01:24:19 
tags: redis 
---
# redis客户端和服务器
# 客户端
- redis服务器中，保存着clients链表
```c
struct redisServer {
    //一个链表，报错了所有客户端状态
    list *clients;
}
```
- 客户端种类
    - 伪客户端，伪客户端的fd属性为-1。redis有两个地方用到伪客户端，一个是AOF载入时，一个是执行lua脚本
        - lua客户端在redis服务器期间都会一直存在
    - 普通客户端，fd正整数
- flag 标志主从服务器，lua客户端
- 输入输出缓冲区
- 命令与命令参数
# 服务器
## serverCron函数
- 更新服务器时间缓存
    - redis需要获取时间的场景，因为每次获取时间都是系统调用，比较费时，所以会将时间缓存
- 更新LRU时钟
    - 对象的lru属性，表明最后一次访问的时间
- 更新服务器的每秒执行命令次数
    - 每100毫秒抽样计算的方式

- 更新服务器内存峰值记录
- 处理SIGTERM信号
    - redis启动时，为SIGTERM信号关联信号处理器，该处理器会在接到信号后，打开服务器的标识位
    - serverCron函数会定期检查该标识，来决定是否关闭服务器
- 管理客户端资源
- 管理数据库资源
- 执行延迟的BGREWRITAOF
    - BGSAVE期间，会阻塞GBWRITEAOF
- 检测持久化操作的允许状态
- 将AOF缓冲区文件写入AOF文件
## 初始化服务器
- 初始化服务器状态结构
- 载入配置选项
    - 如果用户设置了相关的值，会更新配置
    - 如果没有设置，则会沿用之前默认的配置
- 初始化服务器的数据结构
    - 为信号创建信号处理器
    - 创建共享对象
    - 打开监听端口
    - 创建时间事件
    - 写入AOF文件
    - 初始化IO模块
## 重点回顾
![](https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/20181119231826122_1122947758.png)
