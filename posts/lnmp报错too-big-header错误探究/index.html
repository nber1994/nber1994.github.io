<!DOCTYPE html>
<html lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>lnmp报错too-big-header错误探究</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">

        <title>lnmp报错too-big-header错误探究</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>

<header>
        <section id="page-title">
            <h1><a href="/">nber1994</a></h1>

          <div class="date-time-title post">
			<a  href="/">All</a>
          </div>
			
			
          <div class="date-time-title post">
			<a href="/posts/">Posts</a>
          </div>
			
          <div class="date-time-title post">
			<a href="/categories/">Categories</a>
          </div>
			
          <div class="date-time-title post">
			<a href="/tags/">Tags</a>
          </div>
			
          <div class="date-time-title post">
			<a href="/about">About</a>
          </div>
			
	

        </section>
</header>

<div id="icon">
<script type="text/javascript">


    function chunkSubstr(str, size) {
            const numChunks = Math.ceil(str.length / size)
            const chunks = new Array(numChunks)

            for (let i = 0, o = 0; i < numChunks; ++i, o += size) {
                    chunks[i] = str.substr(o, size)
                }

            return chunks
        }
    var pic = [];
    pic[0] = "https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/qRKvRQ20220116152554.jpg";
    pic[1] = "https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/nEf3GW20220116150946.jpg";
    pic[2] = "https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/ITL6SB20220116154359.jpg";
    pic[3] = "https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/3QAQ7M20220116154758.jpg";
    pic[4] = "https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/HCCsx620220116160636.jpg";
    pic[5] = "https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/c4zSPk20220116161109.jpg";
    pic[6] = "https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/Bm5IHA20220116161518.jpg";
    pic[7] = "https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/lpcstW20220116161917.jpg";
    pic[8] = "https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/MSCA4K20220116162440.jpg";

    var talk = [];
    talk[0] = "Help poor children in Uganda!";
    talk[1] = "Bad programmers worry about the code. Good programmers worry about data structures and their relationships.";
    talk[2] = "So, dear Redis community, today I’m stepping back as the Redis maintainer.";
    talk[3] = "Don't tune for speed until you've measured.";
    talk[4] = "C is quirky, flawed, and an enormous success.";
    talk[5] = "I've never thought of PHP as more than a simple tool to solve problems.";
    talk[6] = "Java is C++ without the guns, clubs and knives.";
    talk[7] = "Life is short, you need Python!";
    talk[8] = "C makes it easy to shoot yourself in the foot; C++ makes it harder, but when you do it blows your whole leg off.";

    var randomBgIndex = Math.floor( Math.random() * 8 );


    document.write("<img src=" + pic[randomBgIndex] + ">")
    document.write("<span style='font-size:12px'>" + talk[randomBgIndex] + " </span>")
    document.write("</div>")

</script>
</div>
<br>

	
<main>
    <article>
        <h1>lnmp报错too-big-header错误探究</h1>
        <div id="common-a">
            <b><time>2018-01-08</time></b>
            
            <a href="/categories/php"> ❐php</a>
            
            
        </div>
        <div>
            <blockquote>
<p>之前遇到的一个偶发的错误，探讨下到底是怎么肥四</p>
</blockquote>
<h1 id="1背景">1.背景</h1>
<p>遇到nginx报出了如下的error，导致服务为502 bad gateway, 而且某些请求稳定复现，但是其他请求缺没有问题，正常返回,正常情况下，php的warning并不会导致流程的中断</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#099">2018</span><span style="color:#000;font-weight:bold">/</span><span style="color:#099">01</span><span style="color:#000;font-weight:bold">/</span><span style="color:#099">08</span> <span style="color:#099">15</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">50</span><span style="color:#000;font-weight:bold">:</span><span style="color:#099">20</span> [error] <span style="color:#099">15477</span><span style="color:#998;font-style:italic">#0: *2941700922 upstream sent too big header while reading response header from upstream, client: xx.xx.xxx, server: test.com, request: &#34;POST /test/test HTTP/1.1&#34;, upstream: &#34;fastcgi://127.0.0.1:xxxx&#34;, host: &#34;xxxxxx&#34;, referrer: &#34;xxxxxx&#34;
</span></code></pre></div><p>一时之间不知道原因，唯一有异常的是warninig日志较多，推测可能是php-fpm会把warning日志加到response header头里,导致头部过大报错</p>
<p>php代码中存在类似与以下的错误片段：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">&lt;?</span>php
    <span style="color:#008080">$a</span> <span style="color:#000;font-weight:bold">=</span> [
        <span style="color:#d14">&#39;a&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;123&#39;</span>,
        <span style="color:#d14">&#39;b&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;123&#39;</span>,
        <span style="color:#d14">&#39;c&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;123&#39;</span>,
        <span style="color:#d14">&#39;d&#39;</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#d14">&#39;123&#39;</span>,
    ];

    <span style="color:#000;font-weight:bold">foreach</span> (<span style="color:#008080">$a</span>[<span style="color:#d14">&#39;nber1994&#39;</span>] <span style="color:#000;font-weight:bold">as</span> <span style="color:#008080">$item</span>) {
        <span style="color:#d14">/**
</span><span style="color:#d14">            do something...
</span><span style="color:#d14">        */</span>    
    }
</code></pre></div><p>此时会报warning的错误，类似于</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
php message<span style="color:#000;font-weight:bold">:</span> php Warning<span style="color:#000;font-weight:bold">:</span>  Invalid argument supplied <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">foreach</span>() in XXXXX<span style="color:#000;font-weight:bold">.</span>php on line <span style="color:#099">206</span>
</code></pre></div><p><strong>大量的warning如果会被加到header头里的话，会触发nginx的相关配置(如果有的话),导致报错,看起来解释的通</strong>
但是是否真的是因为header头过大导致的呢，探究一下</p>
<h1 id="2简单的分析一次请求的日志行为">2.简单的分析一次请求的日志行为</h1>
<p>该情况是线上问题，无法抓取到问题发生时，php-fpm与nginx之间到底发生了什么，所以准备在自己的开发环境复现, 不过首先需要能够对nginx与php-fpm进程间通信的数据进行抓取</p>
<h2 id="21-抓取php-fpm与nginx之间的通信数据">2.1 抓取php-fpm与nginx之间的通信数据</h2>
<h3 id="211-php监听端口通信方式的监听">2.1.1 php监听端口通信方式的监听</h3>
<p>速度较unix socket较慢，但是支持跨机器调用，我们可以通过tcpdump进行抓取</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">tcpdump -X -i any  port <span style="color:#099">9999</span> &gt; /tmp/tcpdump.log
</code></pre></div><h4 id="ps开放php端口对外提供fastcgi服务的方法">ps:开放php端口对外提供fastcgi服务的方法</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">1.设置防火墙,开放你的端口
2.php-fpm配置增加：
<span style="color:#008080">listen</span> <span style="color:#000;font-weight:bold">=</span> 公网IP:9085
listen.allowed_clients <span style="color:#000;font-weight:bold">=</span> 192.168.10.66 <span style="color:#998;font-style:italic">#设置允许连接到 FastCGI 的服务器 IPV4 地址。如果允许所有那么把这条注释掉即可</span>
</code></pre></div><h3 id="212-以unix-socket方式通信数据的抓取">2.1.2 以unix socket方式通信数据的抓取</h3>
<p>该方法速度较快，性能高,可以通过监听socket通道得到数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#0086b3">cd</span> /path/to/php.sock
mv php.sock php.sock.orig
socat -t100 -x -v UNIX-LISTEN:php.sock,mode<span style="color:#000;font-weight:bold">=</span>777,reuseaddr,fork UNIX-CONNECT:php.sock.orig
将socket通道的内容转发一份到另一个socket,进行监听
</code></pre></div><h3 id="213-抓取到的数据大概的样子">2.1.3 抓取到的数据大概的样子</h3>
<p><img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/tcpdump.png" alt="抓到的数据"></p>
<h2 id="22-简单分析">2.2 简单分析</h2>
<p>让我们观察下日志，
首先可以看到tcp的建立链接数据，可以顺便直观了解下tcp的三次握手:P</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">12:09:25.581210 IP 127.0.0.1.58984 &gt; 127.0.0.1.9999: Flags <span style="color:#000;font-weight:bold">[</span>S<span style="color:#000;font-weight:bold">]</span>, seq 3550696989, win 65495, options <span style="color:#000;font-weight:bold">[</span>mss 65495,sackOK,TS val <span style="color:#099">1133088550</span> ecr 0,nop,wscale 7<span style="color:#000;font-weight:bold">]</span>, length <span style="color:#099">0</span>
        0x0000:  <span style="color:#099">4500</span> 003c d93b <span style="color:#099">4000</span> <span style="color:#099">4006</span> 637e 7f00 <span style="color:#099">0001</span>  E..&lt;.;@.@.c~....
        0x0010:  7f00 <span style="color:#099">0001</span> e668 270f d3a3 561d <span style="color:#099">0000</span> <span style="color:#099">0000</span>  .....h<span style="color:#d14">&#39;...V.....
</span><span style="color:#d14">        0x0020:  a002 ffd7 4619 0000 0204 ffd7 0402 080a  ....F...........
</span><span style="color:#d14">        0x0030:  4389 8f26 0000 0000 0103 0307            C..&amp;........
</span><span style="color:#d14">12:09:25.581249 IP 127.0.0.1.9999 &gt; 127.0.0.1.58984: Flags [S.], seq 457907882, ack 3550696990, win 65483, options [mss 65495,sackOK,TS val 1133088550 ecr 1133088550,nop,wscale 7], length 0
</span><span style="color:#d14">        0x0000:  4500 003c 0000 4000 4006 3cba 7f00 0001  E..&lt;..@.@.&lt;.....
</span><span style="color:#d14">        0x0010:  7f00 0001 270f e668 1b4b 1eaa d3a3 561e  ....&#39;</span>..h.K....V.
        0x0020:  a012 ffcb 396f <span style="color:#099">0000</span> <span style="color:#099">0204</span> ffd7 <span style="color:#099">0402</span> 080a  ....9o..........
        0x0030:  <span style="color:#099">4389</span> 8f26 <span style="color:#099">4389</span> 8f26 <span style="color:#099">0103</span> <span style="color:#099">0307</span>            C..&amp;C..&amp;....
12:09:25.581261 IP 127.0.0.1.58984 &gt; 127.0.0.1.9999: Flags <span style="color:#000;font-weight:bold">[</span>.<span style="color:#000;font-weight:bold">]</span>, ack 1, win 512, options <span style="color:#000;font-weight:bold">[</span>nop,nop,TS val <span style="color:#099">1133088550</span> ecr 1133088550<span style="color:#000;font-weight:bold">]</span>, length <span style="color:#099">0</span>
        0x0000:  <span style="color:#099">4500</span> <span style="color:#099">0034</span> d93c <span style="color:#099">4000</span> <span style="color:#099">4006</span> <span style="color:#099">6385</span> 7f00 <span style="color:#099">0001</span>  E..4.&lt;@.@.c.....
        0x0010:  7f00 <span style="color:#099">0001</span> e668 270f d3a3 561e 1b4b 1eab  .....h<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>...V..K..
        0x0020:  <span style="color:#099">8010</span> <span style="color:#099">0200</span> 602b <span style="color:#099">0000</span> <span style="color:#099">0101</span> 080a <span style="color:#099">4389</span> 8f26  ....<span style="color:#d14">`</span>+......C..&amp;
        0x0030:  <span style="color:#099">4389</span> 8f26                                C..&amp;
</code></pre></div><h3 id="221-一次请求的nginx-error日志">2.2.1 一次请求的nginx-error日志</h3>
<p><img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/one-hit-error-log.png" alt="nginx-error"></p>
<h3 id="222-一次请求的tcpdump的日志">2.2.2 一次请求的tcpdump的日志</h3>
<p><img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/one-hit-tcpdump-log.png" alt="tcpdump-log"></p>
<h3 id="223-简单结论">2.2.3 简单结论</h3>
<h4 id="观察到的现象">观察到的现象</h4>
<ul>
<li>php-fpm确实将warning与error日志都传给了nginx</li>
<li>tcpdump的日志，明显响应头大于fastcgi_buffer_size设置的大小，但是并未报错</li>
<li>nginx-error日志，可以明显的发现，日志是一段一段的，大小和fastcgi_buffer_size的大小相当，</li>
</ul>
<h4 id="得到的初步结论">得到的初步结论</h4>
<p>对比nginx日志与tcpdump的日志的量，我们能看到:</p>
<p>1.<strong>php-fpm确实会将warning与error传递给nginx</strong></p>
<p>2.<strong>不管fastcgi_buffer_size设置了多少，其实是根据fastcgi_buffer_size的大小来一段一段的读取php-fpm的响应头，不管传了多少的header，都会按照fastcgi_buffer_size的大小，一段一段的读取，然后写入到nginx的日志</strong></p>
<blockquote>
<p>得到了上述结论，我们大致可以确定，并不是因为header头过大，或者说php-fpm传递给nginx的数据超过fastcgi_buffer_size的值才报出的502,那到底是为什么会报相关错误呢？这就需要探究下nginx内部了</p>
</blockquote>
<h1 id="3nginx内部发生了什么">3.nginx内部发生了什么</h1>
<p>首先我们知道：</p>
<ul>
<li>nginx发送请求数据与接收来自后端服务器的响应可以同时进行，是一种全双工方式；</li>
<li>nginx接收到了后端服务器的响应，什么时候向客户端转发响应呢? 对于http响应头部，nginx只有在接收到了所有来自后端服务器的响应头部后，才会转发给客户端。对于http响应包体，则nginx边接收后端服务器的响应包体，边发给客户端</li>
</ul>
<h2 id="31-fastcgi_buffer_size">3.1 fastcgi_buffer_size</h2>
<p>我们知道，fastcgi_buffer_size与proxy_buffer_size这两个参数会影响到响应头, 其中proxy_buffer_size影响的是nginx作为反向代理时的参数
对于nginx配置文件中的fastcgi_buffer_size，文档中是这么写的</p>
<p><img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/fastcgi_buffer_size.png" alt="文档"></p>
<p>其中 <strong>the first part of the response received from the FastCGI server.</strong>,这个参数指定的是接受到fastcgi-server端的第一部分的响应（一般是response header），在lnmp的场景里，fastcgi-server就是php部分
其中这个first part的含义是这样子的，由于upstream是一个通用的组件，它不知道后端的协议，而对于http场景来说，由于http是需要header的，而后端的协议不一定有头，此时就需要我们通过解析后端的协议，然后来设置好发送给client的头，最终发送给client，通过上面的观察，我们发现php的错误信息也会包含其中</p>
<p>以下是所谓的正常情况下的<strong>the first part of the response</strong>的结构</p>
<p><img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/fastcgi-header.png" alt="header"></p>
<ul>
<li>对于接收到的来自后端服务器的响应头部。以上是一个fastcgi格式的响应报文，需要从fastcgi格式的报文中提取出http响应头部，因此需要经过状态机处理，从而解析出http响应头部。</li>
<li>nginx接收后端服务的响应也应该是一种fastcgi报文格式。从图中可以看出，每一个http响应包头前面都加上了fastcgi头部，而每一个http响应包头都有可能由多条http响应头部组成。</li>
<li>我们暂且称每一个fastcgi头部 + http响应包头为一个组， nginx使用扫描法，扫描每一组。每一个组使用两个状态机，一个状态机解析这个组内的fastcgi头部， 另一个状态机解析这个组内的http响应包头，从而获取到每一个http响应头部。</li>
</ul>
<h2 id="32-nginx代码报错分析">3.2 nginx代码报错分析</h2>
<p>源码中报错的位置如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/code.png" alt="error"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#998;font-style:italic">//nginx接收来自上游服务器的响应头部
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">ngx_http_upstream_process_header</span>(ngx_http_request_t <span style="color:#000;font-weight:bold">*</span>r, ngx_http_upstream_t <span style="color:#000;font-weight:bold">*</span>u)
{
    <span style="color:#998;font-style:italic">//循环接收来自后端服务器的响应头部，并使用状态机解析
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">for</span> ( ;; )
    {
        n <span style="color:#000;font-weight:bold">=</span> c<span style="color:#000;font-weight:bold">-&gt;</span>recv(c, u<span style="color:#000;font-weight:bold">-&gt;</span>buffer.last, u<span style="color:#000;font-weight:bold">-&gt;</span>buffer.end <span style="color:#000;font-weight:bold">-</span> u<span style="color:#000;font-weight:bold">-&gt;</span>buffer.last);

        <span style="color:#998;font-style:italic">//表示还需要再次接收来自上游服务器的响应,重新注册读事件到epoll中
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (n <span style="color:#000;font-weight:bold">==</span> NGX_AGAIN)
        {
            ngx_handle_read_event(c<span style="color:#000;font-weight:bold">-&gt;</span>read, <span style="color:#099">0</span>);
            <span style="color:#000;font-weight:bold">return</span>;
        }

        <span style="color:#998;font-style:italic">//更新接收缓冲区
</span><span style="color:#998;font-style:italic"></span>        u<span style="color:#000;font-weight:bold">-&gt;</span>buffer.last <span style="color:#000;font-weight:bold">+=</span> n;

        <span style="color:#998;font-style:italic">//调用http模块的方法，解析响应头部
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//fastcgi为: ngx_http_fastcgi_process_header
</span><span style="color:#998;font-style:italic"></span>        rc <span style="color:#000;font-weight:bold">=</span> u<span style="color:#000;font-weight:bold">-&gt;</span>process_header(r);

        <span style="color:#998;font-style:italic">//表示包头还没有完全接收到
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (rc <span style="color:#000;font-weight:bold">==</span> NGX_AGAIN)
        {
            <span style="color:#998;font-style:italic">//已经读取到末尾
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> (u<span style="color:#000;font-weight:bold">-&gt;</span>buffer.last <span style="color:#000;font-weight:bold">==</span> u<span style="color:#000;font-weight:bold">-&gt;</span>buffer.end) {
                ngx_log_error(NGX_LOG_ERR, c<span style="color:#000;font-weight:bold">-&gt;</span>log, <span style="color:#099">0</span>,
                        <span style="color:#d14">&#34;upstream sent too big header&#34;</span>);

                ngx_http_upstream_next(r, u,
                        NGX_HTTP_UPSTREAM_FT_INVALID_HEADER);
                <span style="color:#000;font-weight:bold">return</span>;
            }
            <span style="color:#000;font-weight:bold">continue</span>;
        }
    }
}
</code></pre></div><p>可以看到，当处理头部的会调函数process_header返回NGX_AGAIN,同时已经读取到了response的末尾，则会报错</p>
<h3 id="321处理头部的回调函数process_header伪代码">3.2.1处理头部的回调函数process_header伪代码</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#998;font-style:italic">//解析来自后端服务器发来的响应头部，从fastcgi格式转为nginx格式。
</span><span style="color:#998;font-style:italic">//采用两个状态机，一个解析fastcgi头部，一个解析fastcgi响应包头
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">static</span> ngx_int_t <span style="color:#900;font-weight:bold">ngx_http_fastcgi_process_header</span>(ngx_http_request_t <span style="color:#000;font-weight:bold">*</span>r)
{
    <span style="color:#998;font-style:italic">//循环解析每一个组(fastcgi头部 + 多个http响应头部组成的数据)。因为每次从内核接收到的数据有可能包含多个组
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">for</span> ( ;; )
    {
        <span style="color:#998;font-style:italic">//解析fastcgi的头部
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> (f<span style="color:#000;font-weight:bold">-&gt;</span>state <span style="color:#000;font-weight:bold">&lt;</span> ngx_http_fastcgi_st_data)
        {
            f<span style="color:#000;font-weight:bold">-&gt;</span>pos <span style="color:#000;font-weight:bold">=</span> u<span style="color:#000;font-weight:bold">-&gt;</span>buffer.pos;
            f<span style="color:#000;font-weight:bold">-&gt;</span>last <span style="color:#000;font-weight:bold">=</span> u<span style="color:#000;font-weight:bold">-&gt;</span>buffer.last;

            <span style="color:#998;font-style:italic">//使用状态解析fastcgi的头部
</span><span style="color:#998;font-style:italic"></span>            rc <span style="color:#000;font-weight:bold">=</span> ngx_http_fastcgi_process_record(r, f);
            u<span style="color:#000;font-weight:bold">-&gt;</span>buffer.pos <span style="color:#000;font-weight:bold">=</span> f<span style="color:#000;font-weight:bold">-&gt;</span>pos;
            u<span style="color:#000;font-weight:bold">-&gt;</span>buffer.last <span style="color:#000;font-weight:bold">=</span> f<span style="color:#000;font-weight:bold">-&gt;</span>last;
        }

        <span style="color:#998;font-style:italic">//这个循环用于解析这个组内的每一个http响应头部。因此该组内的http响应包头可能由多个http响应头部组成。
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//而ngx_http_parse_header_line状态机每次只能解析一个http响应头部，因此需要循环解析
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">for</span> ( ;; )
        {
            <span style="color:#998;font-style:italic">//使用状态机解析来自后端服务器发来的http响应头部
</span><span style="color:#998;font-style:italic"></span>            rc <span style="color:#000;font-weight:bold">=</span> ngx_http_parse_header_line(r, <span style="color:#000;font-weight:bold">&amp;</span>u<span style="color:#000;font-weight:bold">-&gt;</span>buffer, <span style="color:#099">1</span>);
            <span style="color:#000;font-weight:bold">if</span> (rc <span style="color:#000;font-weight:bold">==</span> NGX_OK)
            {
                <span style="color:#998;font-style:italic">//解析某个http响应头部成功后，保存到数组链表中
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#998;font-style:italic">/* a header line has been parsed successfully */</span>
                h <span style="color:#000;font-weight:bold">=</span> ngx_list_push(<span style="color:#000;font-weight:bold">&amp;</span>u<span style="color:#000;font-weight:bold">-&gt;</span>headers_in.headers);

                <span style="color:#998;font-style:italic">//保存http响应头部
</span><span style="color:#998;font-style:italic"></span>                ngx_memcpy(h<span style="color:#000;font-weight:bold">-&gt;</span>key.data, r<span style="color:#000;font-weight:bold">-&gt;</span>header_name_start, h<span style="color:#000;font-weight:bold">-&gt;</span>key.len);
                <span style="color:#998;font-style:italic">//保存http响应头部的值
</span><span style="color:#998;font-style:italic"></span>                ngx_memcpy(h<span style="color:#000;font-weight:bold">-&gt;</span>value.data, r<span style="color:#000;font-weight:bold">-&gt;</span>header_start, h<span style="color:#000;font-weight:bold">-&gt;</span>value.len);
                h<span style="color:#000;font-weight:bold">-&gt;</span>hash <span style="color:#000;font-weight:bold">=</span> r<span style="color:#000;font-weight:bold">-&gt;</span>header_hash;

                <span style="color:#998;font-style:italic">//如果是负责均衡模块支持的头部，则把常用头部的指针指向数组链表中相应位置
</span><span style="color:#998;font-style:italic"></span>                hh <span style="color:#000;font-weight:bold">=</span> ngx_hash_find(<span style="color:#000;font-weight:bold">&amp;</span>umcf<span style="color:#000;font-weight:bold">-&gt;</span>headers_in_hash, h<span style="color:#000;font-weight:bold">-&gt;</span>hash,
                                   h<span style="color:#000;font-weight:bold">-&gt;</span>lowcase_key, h<span style="color:#000;font-weight:bold">-&gt;</span>key.len);
                hh<span style="color:#000;font-weight:bold">-&gt;</span>handler(r, h, hh<span style="color:#000;font-weight:bold">-&gt;</span>offset);
            }

            <span style="color:#998;font-style:italic">//解析完成所有的响应头部，则保存响应状态码
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> (rc <span style="color:#000;font-weight:bold">==</span> NGX_HTTP_PARSE_HEADER_DONE)
            {
                <span style="color:#000;font-weight:bold">if</span> (u<span style="color:#000;font-weight:bold">-&gt;</span>headers_in.status)
                {
                    <span style="color:#998;font-style:italic">//后端服务器返回了状态码，则优先使用后端服务的响应状态码
</span><span style="color:#998;font-style:italic"></span>                }
                <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> (u<span style="color:#000;font-weight:bold">-&gt;</span>headers_in.location)
                {
                    <span style="color:#998;font-style:italic">//后端服务器返回了location,则需要给客户端返回302重定向
</span><span style="color:#998;font-style:italic"></span>                }
                <span style="color:#000;font-weight:bold">else</span>
                {
                    <span style="color:#998;font-style:italic">//否则nginx构造200 0k返回给客户端
</span><span style="color:#998;font-style:italic"></span>                    u<span style="color:#000;font-weight:bold">-&gt;</span>headers_in.status_n <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">200</span>;
                    ngx_str_set(<span style="color:#000;font-weight:bold">&amp;</span>u<span style="color:#000;font-weight:bold">-&gt;</span>headers_in.status_line, <span style="color:#d14">&#34;200 OK&#34;</span>);
                }
            }
        }
    }
}
</code></pre></div><p>以上是流程代码，具体细节未展示
以上代码会对http与fastcgi的header分别进行解析</p>
<p><strong>当两个状态机对fastcgi与http头解析如果出错的话（比如header头缺失）,也会返回NGX_AGAIN，如果此时读取到php-fpm返回的header的尾部时，则会报错</strong>
那到底是否是这个原因呢？php-fpm传送了残缺的或者没有传递response header，才导致的报错？我们复现下观察下</p>
<h1 id="4尝试复现">4.尝试复现</h1>
<p>如果可以复现出502，我们就能验证我们的猜想
不断的增大warning的数目，并监听端口与日志，截取502发生时，php-fpm到底传了什么给nginx
出问题时，是因为过多的warning写入到了fastcgi_buffer_size中，我们可以按着这个思路，进行强行复现</p>
<h2 id="41-php脚本">4.1 php脚本</h2>
<p>我们可以尝试着一步步加大error的size，来观察发送502时的日志情况
以下是脚本:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000;font-weight:bold">&lt;?</span>php
<span style="color:#000;font-weight:bold">for</span> (<span style="color:#008080">$i</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; <span style="color:#008080">$i</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#008080">$_GET</span>[<span style="color:#d14">&#39;iterations&#39;</span>]; <span style="color:#008080">$i</span><span style="color:#000;font-weight:bold">++</span>)
        error_log(str_pad(<span style="color:#d14">&#34;a&#34;</span>, <span style="color:#008080">$_GET</span>[<span style="color:#d14">&#39;size&#39;</span>], <span style="color:#d14">&#34;a&#34;</span>));
<span style="color:#000;font-weight:bold">echo</span> <span style="color:#d14">&#34;got here</span><span style="color:#d14">\n</span><span style="color:#d14">&#34;</span>;
</code></pre></div><h2 id="42-日志监听">4.2 日志监听</h2>
<p>同时监听php绑定的端口，得到日志(此时，fastcgi_buffer_size 4K)</p>
<h2 id="43-压测方法">4.3 压测方法</h2>
<p>使用循环对脚本进行请求，不断的增加单条日志的size与迭代次数
，使其向日志里写入更多的字节，同时过滤返回的502以及报错时的迭代次数与每次日志的大小</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">bash~ <span style="color:#000;font-weight:bold">for</span> it in <span style="color:#000;font-weight:bold">{</span>30..200..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">for</span> size in <span style="color:#000;font-weight:bold">{</span>100..250..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;size=</span><span style="color:#008080">$size</span><span style="color:#d14"> iterations=</span><span style="color:#008080">$it</span><span style="color:#d14"> </span><span style="color:#000;font-weight:bold">$(</span>curl -sv <span style="color:#d14">&#34;http://localhost/debug.php?size=</span><span style="color:#008080">$size</span><span style="color:#d14">&amp;iterations=</span><span style="color:#008080">$it</span><span style="color:#d14">&#34;</span> 2&gt;&amp;<span style="color:#099">1</span> | egrep <span style="color:#d14">&#39;^&lt; HTTP&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#d14">&#34;</span>; <span style="color:#000;font-weight:bold">done</span>; <span style="color:#000;font-weight:bold">done</span> | grep <span style="color:#099">502</span> | head

<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">121</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">109</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">33</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">241</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">48</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">226</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">51</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">190</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">60</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">223</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">69</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">127</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">87</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">199</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">96</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">151</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">99</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">106</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">102</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway 
</code></pre></div><p><strong>顺便说下，unix socket方式性能真的很高，这种unix socket通信的情况下，测试语句运行完了也没有报502</strong>
由上可知，我们复现了502,下面我们对日志进行紧张的分析</p>
<h2 id="44-结果分析">4.4 结果分析</h2>
<h3 id="报错的nginx日志">报错的nginx日志</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">2018/01/09 11:39:01 <span style="color:#000;font-weight:bold">[</span>error<span style="color:#000;font-weight:bold">]</span> 4207#0: *2045 FastCGI sent in stderr: <span style="color:#d14">&#34;php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">2018/01/09 11:39:01 [error] 4207#0: *2045 upstream sent too big header while reading response header from upstream, client: 10.30.128.251, server: testtest, request: &#34;</span>GET /debug.php?size<span style="color:#000;font-weight:bold">=</span>121&amp;<span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> HTTP/1.1<span style="color:#d14">&#34;, upstream: &#34;</span>fastcgi://127.0.0.1:9999<span style="color:#d14">&#34;, host: &#34;</span>test.com<span style="color:#d14">&#34;
</span></code></pre></div><p>可以看到我们成功复现了too big header报错:P</p>
<h3 id="正常的nginx-error日志">正常的nginx-error日志</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">2018/01/09 11:39:02 <span style="color:#000;font-weight:bold">[</span>error<span style="color:#000;font-weight:bold">]</span> 4207#0: *2353 FastCGI sent in stderr: <span style="color:#d14">&#34;php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#d14">php message: aaaaaaaaaaaaa
</span></code></pre></div><h3 id="紧张分析">紧张分析</h3>
<p>上面的日志，一个是39:01，一个是39:02的，按照我们的测试脚本，时间越靠后，传递的日志量会越大(至少是之前的3倍)，但是为什么数据量较小的39:01秒的日志触发了502，而数据量较大的39:02没有报错，而且，日志的量也是相同的，明显有截断，明显超出了4K，这也能验证我们的推测，其实fastcgi_buffer_size并不是一个检查值，超过这个值并不会报错。而更像是一个暂存的空间</p>
<h3 id="进一步紧张分析">进一步紧张分析</h3>
<p>我们回去看下之前监控的tcpdump的日志,发现了一些有趣的现象</p>
<p>一次正常的日志</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">        0x0cf0:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x0d00:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x0d10:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x0d20:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> 610a <span style="color:#099">5048</span> <span style="color:#099">5020</span> 6d65 <span style="color:#099">7373</span> <span style="color:#099">6167</span>  aaaaa.php.messag
        0x0d30:  653a <span style="color:#099">2061</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  e:.aaaaaaaaaaaaa
        0x0d40:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x0d50:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x0d60:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x0d70:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x0d80:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x0d90:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> 610a <span style="color:#099">0000</span> <span style="color:#099">0000</span> <span style="color:#099">0106</span> <span style="color:#099">0001</span>  aaaaaaa.........
        0x0da0:  <span style="color:#099">0024</span> <span style="color:#099">0400</span> 436f 6e74 656e 742d <span style="color:#099">7479</span> <span style="color:#099">7065</span>  .$..Content-type
        0x0db0:  3a20 <span style="color:#099">7465</span> <span style="color:#099">7874</span> 2f68 746d 6c0d 0a0d 0a67  :.text/html....g
        0x0dc0:  6f74 <span style="color:#099">2068</span> <span style="color:#099">6572</span> 650a <span style="color:#099">0000</span> <span style="color:#099">0000</span> <span style="color:#099">0103</span> <span style="color:#099">0001</span>  ot.here.........
        0x0dd0:  <span style="color:#099">0008</span> <span style="color:#099">0000</span> <span style="color:#099">0000</span> <span style="color:#099">0000</span> <span style="color:#099">0061</span> <span style="color:#099">6161</span>            .........aaa
        12:09:25.585035 IP 127.0.0.1.9999 &gt; 127.0.0.1.58984: Flags <span style="color:#000;font-weight:bold">[</span>F.<span style="color:#000;font-weight:bold">]</span>, seq 3497, ack 721, win 523, options <span style="color:#000;font-weight:bold">[</span>nop,nop,TS val <span style="color:#099">1133088554</span> ecr 1133088551<span style="color:#000;font-weight:bold">]</span>, length <span style="color:#099">0</span>
        0x0000:  <span style="color:#099">4500</span> <span style="color:#099">0034</span> 918f <span style="color:#099">4000</span> <span style="color:#099">4006</span> ab32 7f00 <span style="color:#099">0001</span>  E..4..@.@..2....
        0x0010:  7f00 <span style="color:#099">0001</span> 270f e668 1b4b 2c53 d3a3 58ee  ....<span style="color:#d14">&#39;..h.K,S..X.
</span><span style="color:#d14">        0x0020:  8011 020b 4fa2 0000 0101 080a 4389 8f2a  ....O.......C..*
</span><span style="color:#d14">        0x0030:  4389 8f27                                C..&#39;</span>
</code></pre></div><p>一次502的日志</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">        0x1f30:  6d65 <span style="color:#099">7373</span> <span style="color:#099">6167</span> 653a <span style="color:#099">2061</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  message:.aaaaaaa
        0x1f40:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1f50:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1f60:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1f70:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1f80:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1f90:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1fa0:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1fb0:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1fc0:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1fd0:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1fe0:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x1ff0:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x2000:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x2010:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x2020:  <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span> <span style="color:#099">6161</span>  aaaaaaaaaaaaaaaa
        0x2030:  <span style="color:#099">6161</span> 610a                                aaa.
12:09:43.315839 IP 127.0.0.1.36564 &gt; 127.0.0.1.9999: Flags <span style="color:#000;font-weight:bold">[</span>.<span style="color:#000;font-weight:bold">]</span>, ack 40961, win 768, options <span style="color:#000;font-weight:bold">[</span>nop,nop,TS val <span style="color:#099">1133106285</span> ecr 1133106285<span style="color:#000;font-weight:bold">]</span>, length <span style="color:#099">0</span>
        0x0000:  <span style="color:#099">4500</span> <span style="color:#099">0034</span> c6d5 <span style="color:#099">4000</span> <span style="color:#099">4006</span> 75ec 7f00 <span style="color:#099">0001</span>  E..4..@.@.u.....
        0x0010:  7f00 <span style="color:#099">0001</span> 8ed4 270f 363a <span style="color:#099">1573</span> 0df7 <span style="color:#099">5365</span>  ......<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>.6:.s..Se
        0x0020:  <span style="color:#099">8010</span> <span style="color:#099">0300</span> e2df <span style="color:#099">0000</span> <span style="color:#099">0101</span> 080a <span style="color:#099">4389</span> d46d  ............C..m
        0x0030:  <span style="color:#099">4389</span> d46d                                C..m
</code></pre></div><p>发现了吗，502报错的情况下，tcpdump抓到的包中，末尾缺少了http的response header,这正验证了我们之前的推测，php-fpm在返回body之前，并没有传递完整的response header给nginx,导致nginx报出来错误</p>
<h2 id="45-暂时的结论">4.5 暂时的结论</h2>
<p>观察上面的日志，报错的最后的响应头不完整或者根本就没有,这个正好会进入到nginx中未解析到header头并且已到header尾部的情况，触发报错
所以，暂时现在可以推断的是，</p>
<p><strong>php-fpm会在一定的情况下向nginx传送不完整的响应头数据，导致nginx解析fastcgi与http的header出错，导致报出502</strong>
这看起来不可思议，竟然是下游服务出了差错，而不是因为nginx内的fastcgi_buffer_size太小导致的错误,不过该问题并不是不可能发生：
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/gis.png" alt="哈哈"></p>
<h1 id="5-探究下不同fastcgi_buffer_size下的502发生情况">5. 探究下不同fastcgi_buffer_size下的502发生情况</h1>
<h2 id="51-fastcgi_buffer_size-1k">5.1 fastcgi_buffer_size 1k</h2>
<h3 id="nginx日志">nginx日志</h3>
<p>不会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/1k-error-log.png" alt="error-log"></p>
<p>会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/1k-502-error-log.png" alt="error-log"></p>
<h3 id="tcpdump的日志">tcpdump的日志</h3>
<p>不会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/1k-tcpdump-log.png" alt="tcp-error"></p>
<p>会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/1k-tcpdump-502-log.png" alt="tcp-error"></p>
<h3 id="测试结果">测试结果</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">bash~ <span style="color:#000;font-weight:bold">for</span> it in <span style="color:#000;font-weight:bold">{</span>30..200..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">for</span> size in <span style="color:#000;font-weight:bold">{</span>100..250..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;size=</span><span style="color:#008080">$size</span><span style="color:#d14"> iterations=</span><span style="color:#008080">$it</span><span style="color:#d14"> </span><span style="color:#000;font-weight:bold">$(</span>curl -sv <span style="color:#d14">&#34;http://test/debug.php?size=</span><span style="color:#008080">$size</span><span style="color:#d14">&amp;iterations=</span><span style="color:#008080">$it</span><span style="color:#d14">&#34;</span> 2&gt;&amp;<span style="color:#099">1</span> | egrep <span style="color:#d14">&#39;^&lt; HTTP&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#d14">&#34;</span>; <span style="color:#000;font-weight:bold">done</span>; <span style="color:#000;font-weight:bold">done</span> | grep <span style="color:#099">502</span> | head
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">121</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">190</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">109</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">33</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">202</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">33</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">127</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">36</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">184</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">36</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">241</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">36</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">169</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">39</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">205</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">42</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">229</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">42</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
</code></pre></div><h2 id="52-fastcgi_buffer_size-2k">5.2 fastcgi_buffer_size 2k</h2>
<h3 id="nginx日志-1">nginx日志</h3>
<p>不会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/2k-error-log.png" alt="error-log"></p>
<p>会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/2k-502-error-log.png" alt="error-log"></p>
<h3 id="tcpdump的日志-1">tcpdump的日志</h3>
<p>不会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/2k-tcpdump-log.png" alt="tcp-error"></p>
<p>会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/2k-tcpdump-error-502-log.png" alt="tcp-error"></p>
<h3 id="测试结果-1">测试结果</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">bash~ <span style="color:#000;font-weight:bold">for</span> it in <span style="color:#000;font-weight:bold">{</span>30..200..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">for</span> size in <span style="color:#000;font-weight:bold">{</span>100..250..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;size=</span><span style="color:#008080">$size</span><span style="color:#d14"> iterations=</span><span style="color:#008080">$it</span><span style="color:#d14"> </span><span style="color:#000;font-weight:bold">$(</span>curl -sv <span style="color:#d14">&#34;http://test/debug.php?size=</span><span style="color:#008080">$size</span><span style="color:#d14">&amp;iterations=</span><span style="color:#008080">$it</span><span style="color:#d14">&#34;</span> 2&gt;&amp;<span style="color:#099">1</span> | egrep <span style="color:#d14">&#39;^&lt; HTTP&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#d14">&#34;</span>; <span style="color:#000;font-weight:bold">done</span>; <span style="color:#000;font-weight:bold">done</span> | grep <span style="color:#099">502</span> | head
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">121</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">190</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">109</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">33</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">229</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">42</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">241</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">48</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">106</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">51</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">226</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">51</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">175</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">54</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">190</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">60</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">148</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">63</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
</code></pre></div><h2 id="53-fastcgi_buffer_size-4k">5.3 fastcgi_buffer_size 4k</h2>
<h3 id="nginx日志-2">nginx日志</h3>
<p>不会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/4k-error-log.png" alt="error-log"></p>
<p>会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/4k-error-502-log.png" alt="error-log"></p>
<h3 id="tcpdump的日志-2">tcpdump的日志</h3>
<p>不会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/4k-tcpdump-error-log.png" alt="tcp-error"></p>
<p>会报502的错误日志
<img src="https://cdn.jsdelivr.net/gh/nber1994/fu0k@master/uPic/4k-tcpdump-502-error-log.png" alt="tcp-error"></p>
<h3 id="测试结果-2">测试结果</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">bash~ <span style="color:#000;font-weight:bold">for</span> it in <span style="color:#000;font-weight:bold">{</span>30..200..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">for</span> size in <span style="color:#000;font-weight:bold">{</span>100..250..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;size=</span><span style="color:#008080">$size</span><span style="color:#d14"> iterations=</span><span style="color:#008080">$it</span><span style="color:#d14"> </span><span style="color:#000;font-weight:bold">$(</span>curl -sv <span style="color:#d14">&#34;http://test/debug.php?size=</span><span style="color:#008080">$size</span><span style="color:#d14">&amp;iterations=</span><span style="color:#008080">$it</span><span style="color:#d14">&#34;</span> 2&gt;&amp;<span style="color:#099">1</span> | egrep <span style="color:#d14">&#39;^&lt; HTTP&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#d14">&#34;</span>; <span style="color:#000;font-weight:bold">done</span>; <span style="color:#000;font-weight:bold">done</span> | grep <span style="color:#099">502</span> | head
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">121</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">109</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">33</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">241</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">48</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">226</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">51</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">190</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">60</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">223</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">69</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">127</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">87</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">199</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">96</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">151</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">99</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">106</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">102</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
</code></pre></div><h2 id="54-观察发现">5.4 观察发现</h2>
<p>由上1k，2k，4k的比对结果，我们可以得出以下结论</p>
<p>综合以上502报错时的size与iteration的值的乘积，我们可以发现，不同fastcgi_buffer_size下，其实发生502错误时的php-fpm传给nginx的数据的大小基本是一样的
<strong>提高fastcgi_buffer_size的大小，并不能减少too big header的发生风险</strong>
但是建议是设置成操作系统分页的大小</p>
<h1 id="6-结论">6. 结论</h1>
<p>经过探究，我们最终可以得到:</p>
<p>1.<strong>php-fpm确实会将warning与error传递给nginx</strong></p>
<p>2.<strong>不管fastcgi_buffer_size设置了多少，其实是根据fastcgi_buffer_size的大小来一段一段的读取php-fpm的响应头，不管传了多少的header，都会按照fastcgi_buffer_size的大小，一段一段的读取，然后写入到nginx的日志</strong></p>
<p>3.<strong>php-fpm会在一定的情况下向nginx传送不完整的响应头数据，导致nginx解析fastcgi与http的header出错，导致报出502</strong></p>
<p>4.<strong>提高fastcgi_buffer_size的大小，并不能减少too big header的发生风险</strong></p>
<h1 id="7-疑问">7. 疑问</h1>
<p>经过以上的探究，我们可以看到以上的结论，但是仍有很多疑问</p>
<p>1.为什么php-fpm发送的数据会缺少header</p>
<p>2.有没有其它情况会导致too big header报错</p>
<p>3.线上问题是仅有特定的请求参数会稳定复现，其他的则不会复现，到底发生了什么？是我们探究的原因导致的吗？</p>
<p>以上的疑问待进一步的探究</p>
<h1 id="8-对疑问进一步分析">8. 对疑问进一步分析</h1>
<p>经过老司机的指点，对以上压测得出的数据进行进一步的分析，
上面我们探究了在不同fastcgi_buffer_size下的502出错情况</p>
<p>1K</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">bash~ <span style="color:#000;font-weight:bold">for</span> it in <span style="color:#000;font-weight:bold">{</span>30..200..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">for</span> size in <span style="color:#000;font-weight:bold">{</span>100..250..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;size=</span><span style="color:#008080">$size</span><span style="color:#d14"> iterations=</span><span style="color:#008080">$it</span><span style="color:#d14"> </span><span style="color:#000;font-weight:bold">$(</span>curl -sv <span style="color:#d14">&#34;http://test/debug.php?size=</span><span style="color:#008080">$size</span><span style="color:#d14">&amp;iterations=</span><span style="color:#008080">$it</span><span style="color:#d14">&#34;</span> 2&gt;&amp;<span style="color:#099">1</span> | egrep <span style="color:#d14">&#39;^&lt; HTTP&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#d14">&#34;</span>; <span style="color:#000;font-weight:bold">done</span>; <span style="color:#000;font-weight:bold">done</span> | grep <span style="color:#099">502</span> | head
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">121</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">190</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">109</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">33</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">202</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">33</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">127</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">36</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">184</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">36</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">241</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">36</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">169</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">39</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">205</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">42</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">229</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">42</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
</code></pre></div><p>2k</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">bash~ <span style="color:#000;font-weight:bold">for</span> it in <span style="color:#000;font-weight:bold">{</span>30..200..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">for</span> size in <span style="color:#000;font-weight:bold">{</span>100..250..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;size=</span><span style="color:#008080">$size</span><span style="color:#d14"> iterations=</span><span style="color:#008080">$it</span><span style="color:#d14"> </span><span style="color:#000;font-weight:bold">$(</span>curl -sv <span style="color:#d14">&#34;http://test/debug.php?size=</span><span style="color:#008080">$size</span><span style="color:#d14">&amp;iterations=</span><span style="color:#008080">$it</span><span style="color:#d14">&#34;</span> 2&gt;&amp;<span style="color:#099">1</span> | egrep <span style="color:#d14">&#39;^&lt; HTTP&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#d14">&#34;</span>; <span style="color:#000;font-weight:bold">done</span>; <span style="color:#000;font-weight:bold">done</span> | grep <span style="color:#099">502</span> | head
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">121</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">190</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">109</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">33</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">229</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">42</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">241</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">48</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">106</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">51</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">226</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">51</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">175</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">54</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">190</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">60</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">148</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">63</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
</code></pre></div><p>4k</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">bash~ <span style="color:#000;font-weight:bold">for</span> it in <span style="color:#000;font-weight:bold">{</span>30..200..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">for</span> size in <span style="color:#000;font-weight:bold">{</span>100..250..3<span style="color:#000;font-weight:bold">}</span>; <span style="color:#000;font-weight:bold">do</span> <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;size=</span><span style="color:#008080">$size</span><span style="color:#d14"> iterations=</span><span style="color:#008080">$it</span><span style="color:#d14"> </span><span style="color:#000;font-weight:bold">$(</span>curl -sv <span style="color:#d14">&#34;http://test/debug.php?size=</span><span style="color:#008080">$size</span><span style="color:#d14">&amp;iterations=</span><span style="color:#008080">$it</span><span style="color:#d14">&#34;</span> 2&gt;&amp;<span style="color:#099">1</span> | egrep <span style="color:#d14">&#39;^&lt; HTTP&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#d14">&#34;</span>; <span style="color:#000;font-weight:bold">done</span>; <span style="color:#000;font-weight:bold">done</span> | grep <span style="color:#099">502</span> | head
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">121</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">30</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">109</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">33</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">241</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">48</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">226</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">51</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">190</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">60</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">223</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">69</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">127</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">87</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">199</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">96</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">151</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">99</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
<span style="color:#008080">size</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">106</span> <span style="color:#008080">iterations</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">102</span> &lt; HTTP/1.1 <span style="color:#099">502</span> Bad Gateway
</code></pre></div><h2 id="81-观察">8.1 观察</h2>
<p>对比上述结果，有没有发现什么诡异？
为什么三次压测的结果，得到的502次数都是10次
为什么第一次报错都是在size=121，iteration=30的情况下发生的？</p>
<h2 id="82-进一步分析结果">8.2 进一步分析结果</h2>
<p>我们把每一次的size与iteration进行相乘，我们可以得到如下的一些结果：(添加上开头的php message: 这13个字符)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#000;font-weight:bold">(</span><span style="color:#099">121</span> + 13<span style="color:#000;font-weight:bold">)</span> * <span style="color:#008080">30</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4020</span>
<span style="color:#000;font-weight:bold">(</span><span style="color:#099">109</span> + 13<span style="color:#000;font-weight:bold">)</span> * <span style="color:#008080">33</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">4026</span>
<span style="color:#000;font-weight:bold">(</span><span style="color:#099">241</span> + 13<span style="color:#000;font-weight:bold">)</span> * <span style="color:#008080">48</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">12192</span>
<span style="color:#000;font-weight:bold">(</span><span style="color:#099">226</span> + 13<span style="color:#000;font-weight:bold">)</span> * <span style="color:#008080">51</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">12189</span>
<span style="color:#000;font-weight:bold">(</span><span style="color:#099">190</span> + 13<span style="color:#000;font-weight:bold">)</span> * <span style="color:#008080">60</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">12180</span>
.....
</code></pre></div><p>我们知道1024是程序员日，那上面的数据有什么敏感的吗?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#099">1024</span> * <span style="color:#008080">4</span> <span style="color:#000;font-weight:bold">=</span> 4096,
<span style="color:#099">4096</span> * <span style="color:#008080">3</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">12288</span>
....
</code></pre></div><h1 id="甩锅">甩锅</h1>
<p>对比上面的数据，似乎是php的日志在某一个nk大小的时候(我的测试机器上很可能是4k), 会稳定复现这个问题呢？
这也很好的解释了为什么线上的某些请求会稳定复现这种问题，而其他请求，即使打了更多的php warning日志也不会触发502报警的现象</p>
<p>这回，我们可以把锅甩给php-fpm，我们可以不负责任的胡乱猜测一下，</p>
<p><strong>是否php-fpm内部也存在类似的buffer(在我的测试机器上也许是4k)，也许这段buffer是tcp发送消息的缓冲区，当发送的字节很接近4k时, 就会触发某些bug，导致某些尾部数据的丢失, 而当大小与4k的整数倍的数据相差比较大的数据，则不会丢失数据, emmm，也许是在重新分配buffer的时候出了问题，导致的数据丢失:P</strong></p>
<h1 id="参考">参考</h1>
<p>部分内容参考自以下内容，感谢以下作者对知识的分享
<a href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html">http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html</a>
<a href="http://www.pagefault.info/?p=273">http://www.pagefault.info/?p=273</a>
<a href="http://blog.csdn.net/ApeLife/article/details/78001508?ref=myrecommend">http://blog.csdn.net/ApeLife/article/details/78001508?ref=myrecommend</a>
<a href="http://blog.csdn.net/midion9/article/details/51384002">http://blog.csdn.net/midion9/article/details/51384002</a>
<a href="https://www.imooc.com/article/19278">https://www.imooc.com/article/19278</a>
<a href="https://stackoverflow.com/questions/23844761/upstream-sent-too-big-header-while-reading-response-header-from-upstream">https://stackoverflow.com/questions/23844761/upstream-sent-too-big-header-while-reading-response-header-from-upstream</a></p>
<blockquote>
<p>以上探究仅是个人观点，可能存在错误，欢迎交流~           eamil:m18710895391@163.com</p>
</blockquote>

        </div>
    </article>
</main>
<aside>
	<div>
		<div>
			<h1>LATEST POSTS</h1>
		</div>
		<div id='common-a'>
			<ul>
				
                <div id="lists">
                    <div id=date class="date-time-title">
                        <time>2022-02-17</time>
                    </div>
                    <div class="date-time-title post">
                        <a href="http://nber1994.github.io/posts/channel-select/">golang channel浅析</a>
                    </div>
                </div>
				
                <div id="lists">
                    <div id=date class="date-time-title">
                        <time>2022-02-09</time>
                    </div>
                    <div class="date-time-title post">
                        <a href="http://nber1994.github.io/posts/golang-race%E6%A3%80%E6%B5%8B/">golang-race检测</a>
                    </div>
                </div>
				
                <div id="lists">
                    <div id=date class="date-time-title">
                        <time>2022-02-09</time>
                    </div>
                    <div class="date-time-title post">
                        <a href="http://nber1994.github.io/posts/golang-%E4%BF%A1%E5%8F%B7%E9%87%8F/">golang-信号量</a>
                    </div>
                </div>
				
                <div id="lists">
                    <div id=date class="date-time-title">
                        <time>2022-02-09</time>
                    </div>
                    <div class="date-time-title post">
                        <a href="http://nber1994.github.io/posts/golang%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/">golang知识汇总</a>
                    </div>
                </div>
				
                <div id="lists">
                    <div id=date class="date-time-title">
                        <time>2022-01-15</time>
                    </div>
                    <div class="date-time-title post">
                        <a href="http://nber1994.github.io/posts/golang%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AE%9E%E7%8E%B0/">golang同步机制的实现</a>
                    </div>
                </div>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
    <div id='footer'>
	<p>&copy; 2022 <a href="http://nber1994.github.io/"><b>jingtianyou&#39;s blog</b></a>.
	</p>
    </div>
</footer>

</body>
</html>
